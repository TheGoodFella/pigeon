DROP DATABASE IF EXISTS PIGEON;
CREATE DATABASE PIGEON;
USE PIGEON;

/*TABLES*/
CREATE TABLE USERS(
ID_USER INTEGER NOT NULL AUTO_INCREMENT,
NAME VARCHAR(50) NOT NULL,
LASTNAME VARCHAR(50) NOT NULL,
USERNAME VARCHAR(20) NOT NULL,
PASSWORD VARCHAR(50) NOT NULL,
EMAIL VARCHAR (50) NOT NULL,
IMAGE VARCHAR(50) NOT NULL,
PRIMARY KEY(ID_USER)
);

CREATE TABLE CHANNELS(
ID_CHANNEL INTEGER NOT NULL AUTO_INCREMENT,
NAME VARCHAR(50) NOT NULL,
IMAGE VARCHAR(50) NOT NULL,
CREATION_DATE DATE NOT NULL,
PRIMARY KEY(ID_CHANNEL)
);

CREATE TABLE BELONGS_TO(
ID_CHANNEL INTEGER NOT NULL,
ID_USER INTEGER NOT NULL,
FOREIGN KEY(ID_CHANNEL) REFERENCES CHANNELS(ID_CHANNEL),
FOREIGN KEY(ID_USER) REFERENCES USERS(ID_USER),
PRIMARY KEY(ID_CHANNEL,ID_USER)
);

CREATE TABLE MESSAGES(
ID_MESSAGE INTEGER NOT NULL AUTO_INCREMENT,
TEXT VARCHAR(512) NOT NULL,
SEND_DATE DATETIME NOT NULL,
ID_SENDER INTEGER NOT NULL,
ID_CHANNEL INTEGER NOT NULL,
TYPE ENUM("TEXT","IMAGE") NOT NULL,
PRIMARY KEY(ID_MESSAGE),
FOREIGN KEY(ID_SENDER) REFERENCES USERS(ID_USER),
FOREIGN KEY(ID_CHANNEL) REFERENCES CHANNELS(ID_CHANNEL)
);

/*INSERT*/
INSERT INTO USERS VALUES(1,"MICKEY","MOUSE", "THEGOODFELLA","***","G@G.COM","MM.JPG"),(2,"DONALD","DUCK","SUPERBONNY","****","DD@DD","DD.JPG"),(3,"SCROOGE","MCDUCK","ADYXXX5","**","SM@SM","SM.JPG"),(4,"PAPEROPOLI","PAPII","PAPERINO","**","PP@PP","PP.JPG");
INSERT INTO CHANNELS VALUES(1,"CHAT1","CHAT1.JPG","2016-03-20"),(2,"CHAT2","CHAT2.JPG","2016-03-19");
INSERT INTO BELONGS_TO VALUES(1,1),(1,2),(2,2),(2,3),(1,4);
INSERT INTO MESSAGES VALUES(1,"HEY","2016-03-20 10:57:00",1,1,"TEXT"),(2,"WHATS UP?","2016-03-20 10:59:21",2,1,"TEXT"),(3,"HI GUYS","2016-03-20 11:02:31",3,2,"TEXT");

/*QUERIES*/

/*SELECT USERS BELONGS TO CHANNELS*/
SELECT USERS.NAME, USERS.LASTNAME FROM USERS JOIN BELONGS_TO ON USERS.ID_USER=BELONGS_TO.ID_USER JOIN CHANNELS ON BELONGS_TO.ID_CHANNEL=CHANNELS.ID_CHANNEL WHERE CHANNELS.ID_CHANNEL=2;

/*SHOW ALL CHANNELS*/
DELIMITER //
CREATE PROCEDURE SHOW_ALL_CHANNELS()
BEGIN
	SELECT CHANNELS.ID_CHANNEL FROM CHANNELS;
END //
DELIMITER ;

/*SELECT MESSAGES FOR A CHANNEL*/
DELIMITER //
CREATE PROCEDURE MESSAGE_CHANNEL( IN _CHANNEL VARCHAR(30))
BEGIN
	SELECT TEXT, USERS.NAME, SEND_DATE FROM MESSAGES, CHANNELS, USERS WHERE CHANNELS.NAME=_CHANNEL;
END //
DELIMITER ;

/*SELECT USER IN THAT CHANNEL INSCRIBED*/
DELIMITER //
CREATE PROCEDURE USER_CHANNEL( IN _USERNAME VARCHAR(20))
BEGIN
	SELECT USERS.NAME, LASTNAME, USERNAME, CHANNELS.NAME FROM CHANNELS, USERS, BELONGS_TO WHERE USERS.USERNAME=_USERNAME AND BELONGS_TO.ID_USER=BELONGS_TO.ID_CHANNEL;
END //
DELIMITER ;


/*CREATE A SQL USER TO REMOTELY ACCESS THE DB*/
GRANT ALL ON `PIGEON`.* to 'pigeon'@'%' identified by 'pigeon';
